var Specs=function(){this.context=null,this.document=null,this.init=function(t,e){this.context=t,this.document=e},this.getArtboard=function(t,e,r,a,i){if(t instanceof MSArtboardGroup||r instanceof MSSymbolMaster){var s=[],o=null,n=null,l=null;if(r instanceof MSSymbolMaster&&null!=a){try{var c=a.immutableModelObject();o=r.immutableModelObject().modifiedMasterByApplyingInstance_inDocument_(c,nil).layers()}catch(t){utils.sketchLog(this.context,"getArtboard: exception:"+t.message)}n=r.children().objectEnumerator(),l=r.frame()}else n=t.children().objectEnumerator(),l=t.frame();for(var h=null;h=n.nextObject();)try{var u=h.parentGroup(),y=this.getLayerProperties(h),g={};if(!y.isVisible||null!=u&&"MSShapeGroup"==u.class()||"symbol-master"==y.layerType)continue;var d=null;if(null!=o&&(d=this.getModifiedSymbolLayerRect(h.objectID(),o,null)),g.rect=null!=d?d:this.getLayerRect(h.absoluteRect(),l),i&&(g.rect.x=i.x+g.rect.x,g.rect.y=i.y+g.rect.y),"text"==y.layerType){try{if(g.sid=this.toStringValue(h.objectID()),g.name=this.toStringValue(h.name()),g.fixedWidth=h.textBehaviour(),y.isRenderable){var p=h.style();g.rotation=h.rotation(),g.opacity=p.contextSettings().opacity();var f=this.getLayerRadius(h);f>0&&(g.radius=f);var b=this.getLayerBorders(h,p);b.length>0&&(g.borders=b);var x=this.getLayerFills(h,p);x.length>0&&(g.fills=x);var m=this.getLayerShadow(h,p);m.length>0&&(g.shadow=m)}for(var S=["left","right","center","justify","left"],L=h.attributedStringValue().treeAsDictionary(),v=null,M=0;M<e.length;M++)e[M].key==g.sid&&(v=this.toStringValue(e[M].val));g.font={content:this.toStringValue(L.text),override:v,font:this.toStringValue(h.fontPostscriptName()),size:h.fontSize(),line:h.lineHeight(),spacing:{char:this.toStringValue(null==h.characterSpacing()?0:h.characterSpacing()),para:this.toStringValue(null==h.paragraphStyle()?0:h.paragraphStyle().ParagraphSpacing)},align:S[h.textAlignment()],color:this.getLayerColor(h.textColor()),transform:0};try{for(var k=[],j=L.attributes.objectEnumerator(),w=null;w=j.nextObject();){var A=null==w.NSFont?null:w.NSFont.attributes,V=null==w.NSParagraphStyle?null:w.NSParagraphStyle.style;k.push({content:this.toStringValue(w.text),font:this.toStringValue(null==A?"":A.NSFontNameAttribute),size:this.toStringValue(null==A?"":A.NSFontSizeAttribute),line:this.toStringValue(null==V?0:V.maximumLineHeight),spacing:{char:this.toStringValue(w.NSKern),para:this.toStringValue(null==V?0:V.paragraphSpacing)},align:S[null==V?"left":V.alignment],color:this.toStringValue(null==w.MSAttributedStringColorAttribute?"":w.MSAttributedStringColorAttribute.value),transform:this.toStringValue(w.MSAttributedStringTextTransformAttribute)})}}catch(t){utils.sketchLog(this.context,"getArtboard: exception while parsing text attributes:"+t.message)}0==k.length&&k.push({content:null!=g.font.override?g.font.override:g.font.content,font:g.font.font,size:g.font.size,line:g.font.line,spacing:{char:g.font.spacing.char,para:g.font.spacing.para},align:g.font.align,color:g.font.color,transform:g.font.transform}),g.font.styles=k}catch(t){utils.sketchLog(this.context,"getArtboard: exception while parsing text:"+t.message)}if(h.hasClippingMask()?(this.maskObjectID=null!=u?u.objectID():void 0,this.maskRect=this.getLayerRect(h.absoluteRect(),l)):(null!=u&&this.maskObjectID!=u.objectID()||h.shouldBreakMaskChain())&&(this.maskObjectID=void 0,this.maskRect=void 0),y.isMaskChildLayer&&(g.rect=this.getLayerMaskRect(g.rect)),null!=a)try{g.symbol_instance_id=this.toStringValue(a.objectID())}catch(t){utils.sketchLog(this.context,"getArtboard: exception while parsing text:"+t.message)}g.rect&&s.push(g)}if("symbol"==y.layerType){try{var O=this;(h.availableOverrides()||NSMutableDictionary.dictionary()).forEach(function(t){var r=t.hasOverride(),a=t.overrideValue(),i=t.affectedLayer();r&&!O.isGuid(a)&&e.push({key:i.objectID(),val:a})})}catch(t){utils.sketchLog(this.context,"getArtboard: exception:"+t.message)}this.getArtboard(t,e,h.symbolMaster(),h,{x:g.rect.x,y:g.rect.y}).forEach(function(t){s.push(t)})}r instanceof MSSymbolMaster||(e=[])}catch(t){utils.sketchLog(this.context,"getArtboard: exception:"+t.message)}return i?s:{sid:this.toStringValue(t.objectID()),name:this.toStringValue(t.name()),width:l.width(),height:l.height(),layers:s}}},this.getModifiedSymbolLayerRect=function(t,e,r){if(null==e)return null;for(var a=e.objectEnumerator(),i=null;i=a.nextObject();){if(i.objectID()==t){var s=this.getLayerRect(i.frame());return null==r?s:{x:s.x+r.x,y:s.y+r.y,width:s.width,height:s.height}}if("MSLayerGroup"==i.class()||"MSImmutableLayerGroup"==i.class())try{var o=this.getLayerRect(i.frame());return null!=r&&(o={x:r.x+o.x,y:r.y+o.y}),this.getModifiedSymbolLayerRect(t,i.layers(),o)}catch(t){utils.sketchLog(this.context,"getModifiedSymbolLayerRect: exception:"+t.message)}}return null},this.showHideArtboardTextLayers=function(t,e,r){if(t instanceof MSArtboardGroup||t instanceof MSSymbolMaster)for(var a=t.children().objectEnumerator(),i=null;i=a.nextObject();)try{var s=i.parentGroup(),o=this.getLayerProperties(i);if(null!=s&&"MSShapeGroup"==s.class()||"symbol-master"==o.layerType)continue;for(var n=this.toStringValue(i.objectID()),l=0;l<e.length;l++)if(n==e[l].sid)try{i.setIsVisible(r)}catch(t){utils.sketchLog(this.context,"showHideArtboardTextLayers: exception while hiding text:"+t.message)}"symbol"==o.layerType&&this.showHideArtboardTextLayers(i.symbolMaster(),e,r)}catch(t){utils.sketchLog(this.context,"showHideArtboardTextLayers: exception:"+t.message)}},this.setArtboard=function(t,e){if(null!=e&&null!=e.layers&&(t instanceof MSArtboardGroup||t instanceof MSSymbolMaster))for(var r=t.children().objectEnumerator(),a=null;a=r.nextObject();)try{var i=a.parentGroup(),s=this.getLayerProperties(a);if(null!=i&&"MSShapeGroup"==i.class()||"symbol-master"==s.layerType)continue;for(var o=this.toStringValue(a.objectID()),n=0;n<e.layers.length;n++){var l=e.layers[n];if(o==l.sid)try{a.setStringValue(l.content);break}catch(t){utils.sketchLog(this.context,"setArtboard: exception while setting text:"+t.message)}}if("symbol"==s.layerType)try{var c=a.overrides()||NSMutableDictionary.dictionary();c=NSMutableDictionary.dictionaryWithDictionary(c),(c=this.setLayerOverrides(a.symbolMaster(),a,c,e)).count()>0&&(a.overrides=c)}catch(t){utils.sketchLog(this.context,"setArtboard: exception:"+t.message)}}catch(t){utils.sketchLog(this.context,"setArtboard: exception:"+t.message)}},this.setLayerOverrides=function(t,e,r,a){if(null!=a&&null!=a.layers&&t instanceof MSSymbolMaster){for(var i=t.children().objectEnumerator(),s=null;s=i.nextObject();)try{var o=s.parentGroup(),n=this.getLayerProperties(s);if(null!=o&&"MSShapeGroup"==o.class()||"symbol-master"==n.layerType)continue;for(var l=this.toStringValue(s.objectID()),c=0;c<a.layers.length;c++){var h=a.layers[c],u=!0;if(h.symbol_instance_id!=e.objectID()&&(u=!1),l==h.sid&&u){try{r.setObject_forKey(h.content,l)}catch(t){utils.sketchLog(this.context,"setLayerOverrides: exception while setting text:"+t.message)}break}}if("symbol"==n.layerType)try{var y=null!=r&&r[l]||NSMutableDictionary.dictionary();(y=this.setLayerOverrides(s.symbolMaster(),s,y,a)).count()>0&&r.setObject_forKey(y,l)}catch(t){utils.sketchLog(this.context,"setLayerOverrides: exception in symbol:"+t.message)}}catch(t){utils.sketchLog(this.context,"setLayerOverrides: exception:"+t.message)}return r}},this.getLayerOverrides=function(t,e){var r=null;for(r in t){var a=t[r];if("__NSDictionaryM"==a.class())t[r]=this.getLayerOverrides(a,e);else for(var i=0;i<e.layers.length;i++){var s=e.layers[i];r==s.sid&&(t[r]=s.content)}}return t}};Specs.prototype={guid:function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},isGuid:function(t){return/^(\{){0,1}[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}(\}){0,1}$/gi.test(t)},extend:function(t,e){var e=e||this;for(var r in t)e[r]=t[r];return e},toStringValue:function(t){var e=arguments.length>1?arguments[1]:null,r=new String(t).toString();return e&&e.escapeLine&&(r=r.replace(/\\-/g,"-")),e&&e.encode&&(r=encodeURIComponent(r)),r=r.replace(/\u2028/g,"\n").replace(/\u2029/g,"\n")},getLayerProperties:function(t){for(var e=!0,r=!1,a=!1,i=!1,s=!1,o=t;"MSArtboardGroup"!=o.class()&&"MSSymbolMaster"!=o.class();){var n=o.parentGroup();o.isVisible()||(e=!1),o.isLocked()&&(r=!0),"MSLayerGroup"==n.class()&&n.exportOptions().exportFormats().count()>0&&(a=!0),this.maskObjectID&&n.objectID()==this.maskObjectID&&!o.shouldBreakMaskChain()&&(s=!0),"MSTextLayer"==o.class()&&o.isEmpty()&&(i=!0),o=n}var l="shape",c=t.exportOptions().exportFormats().count()>0;"MSTextLayer"==t.class()?l="text":"MSSymbolInstance"==t.class()?l="symbol":"MSSymbolMaster"==t.class()?l="symbol-master":"MSSliceLayer"==t.class()?l="slice":"MSLayerGroup"==t.class()?l="layer-group":"MSArtboardGroup"==t.class()&&(l="artboard-group");var h="MSTextLayer"==t.class()||"MSShapeGroup"==t.class()||"MSBitmapLayer"==t.class()||"MSSymbolInstance"==t.class();return h=h&&!i&&!a&&!r,{isVisible:e,isLocked:r,hasSlice:a,isMaskChildLayer:s,isEmpty:i,layerType:l,isExportFormatsAvailable:c,isRenderable:h}},getLayerMaskRect:function(t){(t=this.extend(t,{})).maxX=t.x+t.width,t.maxY=t.y+t.height;var e=this.extend(this.maskRect,{});e.maxX=e.x+e.width,e.maxY=e.y+e.height;var r=t.x,a=t.y,i=t.width,s=t.height,o=0,n=0;return!!!(t.maxX<=e.x||t.x>=e.maxX||t.y>=e.maxY||t.maxY<=e.y)&&(t.x<e.x&&(r=e.x,o=e.x-t.x),t.y<e.y&&(a=e.y,n=e.y-t.y),t.maxX>e.maxX?i=i-(t.maxX-e.maxX)-o:i-=o,t.maxY>e.maxY?s=s-(t.maxY-e.maxY)-n:s-=n,{x:r,y:a,width:i,height:s})},getLayerRect:function(t,e){return e?{x:t.x()-e.x(),y:t.y()-e.y(),width:t.width(),height:t.height()}:{x:t.x(),y:t.y(),width:t.width(),height:t.height()}},getLayerColor:function(t){return{r:Math.round(255*t.red()),g:Math.round(255*t.green()),b:Math.round(255*t.blue()),a:t.alpha()}},getLayerGradient:function(t,e){try{for(var r=[],a=["linear","radial","angular"],i=e.stops().objectEnumerator();colorStop=i.nextObject();)r.push({color:this.getLayerColor(colorStop.color()),position:colorStop.position()});return{type:a[e.gradientType()],from:{x:parseFloat(e.from().x),y:parseFloat(e.from().y)},to:{x:parseFloat(e.to().x),y:parseFloat(e.to().y)},colorStops:r}}catch(e){utils.sketchLog(this.context,"getLayerGradient: exception: name-"+this.toStringValue(t.name())+", class-"+this.toStringValue(t.class())),utils.sketchLog(this.context,"getLayerGradient: exception:"+e.message)}return{}},getLayerRadius:function(t){try{if(t.layers&&t.layers().firstObject().fixedRadius)return t.layers().firstObject().fixedRadius()}catch(e){utils.sketchLog(this.context,"getLayerRadius: exception: name-"+this.toStringValue(t.name())+", class-"+this.toStringValue(t.class())),utils.sketchLog(this.context,"getLayerRadius: exception:"+e.message)}return 0},getLayerBorders:function(t,e){var r=[],a=["center","inside","outside"],i=e.borders().objectEnumerator();try{for(;border=i.nextObject();)border.isEnabled()&&(0==border.fillType()?r.push({type:"color",position:a[border.position()],thickness:border.thickness(),color:this.getLayerColor(border.color())}):1==border.fillType()&&r.push({type:"gradient",position:a[border.position()],thickness:border.thickness(),gradient:this.getLayerGradient(t,border.gradient())}))}catch(e){utils.sketchLog(this.context,"getLayerBorders: exception: name-"+this.toStringValue(t.name())+", class-"+this.toStringValue(t.class())),utils.sketchLog(this.context,"getLayerBorders: exception:"+e.message)}return r},getLayerFills:function(t,e){var r=[],a=e.fills().objectEnumerator();try{for(;fill=a.nextObject();)fill.isEnabled()&&(0==fill.fillType()?r.push({type:"color",color:this.getLayerColor(fill.color())}):1==fill.fillType()&&r.push({type:"gradient",gradient:this.getLayerGradient(t,fill.gradient())}))}catch(e){utils.sketchLog(this.context,"getLayerFills: exception: name-"+this.toStringValue(t.name())+", class-"+this.toStringValue(t.class())),utils.sketchLog(this.context,"getLayerFills: exception:"+e.message)}return r},getLayerShadow:function(t,e){var r=[],a=e.shadows().objectEnumerator(),i=e.innerShadows().objectEnumerator();try{for(;shadow=a.nextObject();)shadow.isEnabled()&&r.push({type:shadow instanceof MSStyleShadow?"outer":"inner",offsetX:shadow.offsetX(),offsetY:shadow.offsetY(),blurRadius:shadow.blurRadius(),spread:shadow.spread(),color:this.getLayerColor(shadow.color())});for(;shadow=i.nextObject();)shadow.isEnabled()&&r.push({type:shadow instanceof MSStyleShadow?"outer":"inner",offsetX:shadow.offsetX(),offsetY:shadow.offsetY(),blurRadius:shadow.blurRadius(),spread:shadow.spread(),color:this.getLayerColor(shadow.color())})}catch(e){utils.sketchLog(this.context,"getLayerShadow: exception: name-"+this.toStringValue(t.name())+", class-"+this.toStringValue(t.class())),utils.sketchLog(this.context,"getLayerShadow: exception:"+e.message)}return r},dictionaryToArray:function(t){var e=[],r=null;for(r in t){var a=t.objectForKey(r);"__NSDictionaryM"==a.class()?this.dictionaryToArray(a).forEach(function(t){e.push(t)}):e.push({key:r,val:a})}return e}};