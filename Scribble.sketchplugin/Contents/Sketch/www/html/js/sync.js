var artboardSizes=[],totalArtboardsForSync=0,cfProgressBar=null,cfProgress=null,cfProgressFilled=null,cfProgressPercentage=null,cfProgressPercentageValue=null,selectedProjectName="",projects=[],webViewInit=function(e){window.settings=e,window.webViewData=null,$("#mainSection").addClass("active"),CheckUpdate(),connectRealtime(window.settings.cfURLSocket,window.settings.cfToken.userid),cfProgressBar=$("#cfProgressBar"),cfProgress=$("#cfProgress"),cfProgressFilled=$("#cfProgressFilled"),cfProgressPercentage=$("#cfProgressPercentage"),cfProgressPercentageValue=$("#cfProgressPercentageValue"),"true"==window.settings.isSyncAll?($("#syncAll").attr("checked","checked"),$("#syncSelected").attr("checked",!1)):($("#syncAll").attr("checked",!1),$("#syncSelected").attr("checked","checked")),$.ajax({url:window.settings.cfURLPrefix+"/vi/svcs/scribble/sketch/sketchGetProjects.php",data:{id:window.settings.cfToken.userid,token:window.settings.cfToken.token},type:"POST",cache:!1,dataType:"json",success:function(e){"success"==e.result&&(projects=e.projects,LoadProjects())},error:function(e){},fail:function(e){}}),$("#syncBtn").on("click",function(){var e=$(this);e.attr("disabled",!0),e.removeClass("active"),selectedProjectName=$("#selectProject option:selected").text(),window.webViewData=encodeURI(JSON.stringify({projectId:parseInt($("#selectProject").val()),projectName:$("#selectProject option:selected").text(),isSyncAll:$("input[name='isSyncAll']:checked").val()})),window.location.hash="sync-start",window.location.hash=""}),$("#createProject").on("click",function(){$(".page").removeClass("active"),$("#createProjectError").removeClass("active"),$("#createProjectSection").addClass("active")}),$("#createProjectBtn").on("click",function(){var e=$("#projectName").val();if(0!=e.length){for(var t=0;t<projects.length;t++)if(projects[t].title==e)return void $("#createProjectError").text("A project with same name already exists.").addClass("active");$.ajax({url:window.settings.cfURLPrefix+"/vi/svcs/scribble/sketch/sketchCreateProject.php",data:{id:window.settings.cfToken.userid,token:window.settings.cfToken.token,project_name:e},type:"POST",cache:!1,dataType:"json",success:function(e){"success"==e.result&&(projects=projects.concat(e.project),window.settings.projectId=e.project.id,$("#selectProject").show().removeAttr("data-dropdownjs").next(".dropdownjs").remove(),LoadProjects(),$("#createProjectCancel").trigger("click"))},error:function(e){},fail:function(e){}}),$(".page").removeClass("active"),$("#createProjectSection").addClass("active")}else $("#createProjectError").text("Project name cannot be empty.").addClass("active")}),$("#createProjectCancel").on("click",function(){$(".page").removeClass("active"),$("#mainSection").addClass("active")}),$("#logoutBtn").on("click",function(){$("body > div").removeClass("active"),$("#loadSection").addClass("active"),window.location.hash="logout",window.location.hash=""}),$("#goToPreview").on("click",function(){var e=$(this).attr("data-href");window.webViewData=encodeURI(JSON.stringify({projectLink:e})),window.location.hash="go-to-preview",window.location.hash=""}),$("#getLatestPlugin").on("click",function(){window.location.hash="get-latest-plugin",window.location.hash=""})},LoadProjects=function(){if(projects.length>0){for(var e="",t=0;t<projects.length;t++){var r=!1;projects[t].id==window.settings.projectId&&(r=!0),e+="<option value='"+projects[t].id+"' data-html='<span>"+projects[t].title+"</span>'"+(r?" selected='selected'":"")+">"+projects[t].title+"</option>"}$("#selectProjectLoading").hide(),$("#selectProject").html(e),$("#selectProject").show(),$("#createProject").show(),$("#syncBtn").removeAttr("disabled"),$("#selectProject").dropdown({optionClass:"withripple",renderHtml:!0,onSelected:function(e){}})}else $("#selectProjectLoading").text("No Scribble Project Yet!"),$("#createProject").show()},b64toBlob=function(e){for(var t=atob(e),r=[],o=0;o<t.length;o+=512){for(var c=t.slice(o,o+512),s=new Array(c.length),a=0;a<c.length;a++)s[a]=c.charCodeAt(a);var n=new Uint8Array(s);r.push(n)}return new Blob(r,{type:"image/png"})},SyncArtboard=function(e,t,r){if(null==t);else{startSync(e.projectId);var o=b64toBlob(t),c=b64toBlob(r),s=new FormData,a=e.filename.replace(/[\/\\<>?*;:|&']+/g,"");s.append("files",o,a),s.append("thumb",c,a),s.append("data",JSON.stringify(e)),$.ajax({url:window.settings.cfURLPrefix+"/vi/svcs/scribble/sketch/sketchSyncArtboard.php",data:s,processData:!1,contentType:!1,type:"POST",xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",function(t){t.lengthComputable&&CalculateProgress(t.loaded,t.total,e.filename)},!1),t},success:function(t){"success"==t.result&&specsGenerationNotify(t),SyncArtboardProgress(e.projectId,e.isSyncAll,t.project_uuid,t.page_uuid)},error:function(t){SyncArtboardProgress(e.projectId,e.isSyncAll,"","")},fail:function(t){SyncArtboardProgress(e.projectId,e.isSyncAll,"","")}})}},ActivateSyncButton=function(e){$("#syncBtn").removeAttr("disabled").addClass("active")},SyncArtboardInit=function(e){cfProgressBar.addClass("active"),cfProgressFilled.width(0),cfProgressPercentageValue.text(0),totalArtboardsForSync=e,artboardSizes=[]},SyncArtboardProgress=function(e,t,r,o){if(0==--totalArtboardsForSync){artboardSizes=[],$("#syncBtn").removeAttr("disabled").addClass("active"),cfProgressBar.removeClass("active"),cfProgressFilled.width(0),cfProgressPercentageValue.text(0);var c=window.settings.cfURLPrefix;c+="true"==t?"/vi/share/?project="+r:"/vi/scribble/?page="+o,$("#completeSection textarea").text(c),$("#goToPreview").attr("data-href",c),$(".page").removeClass("active"),$("#completeSection").addClass("active"),endSync(e)}},CalculateProgress=function(e,t,r){for(var o=0,c=0,s=!1,a=0;a<artboardSizes.length;a++)artboardSizes[a].filename==r&&(artboardSizes[a].uploaded=e),s=!0,c+=artboardSizes[a].size,o+=artboardSizes[a].uploaded;s||(artboardSizes.push({uploaded:e,size:t,filename:r}),c+=t,o+=e);var n=o/c*100;n=parseInt(n),cfProgressFilled.width(n/100*240),cfProgressPercentageValue.text(n)};